{"version":3,"sources":["file:///Users/swayambhupanda/Documents/GitHub/applet-framework-demo/extensions/as_framework/framework/assets/scripts/GifPlayer.ts"],"names":["Component","Sprite","SpriteFrame","_decorator","AS","gif","error","ccclass","property","requireComponent","GifPlayer","_frames","_frameIndex","_isPlaying","_width","_height","_sprite","_tempCtx","_tempCanvas","_gifCanvas","_gifCtx","_frameImageData","url","_url","playOnLoad","_playOnLoad","frameIndex","value","_loadGif","play","_renderFrame","pause","awake","getComponent","onLoad","onEnable","fetch","then","res","arrayBuffer","gifParsed","parseGIF","frames","decompressFrames","document","createElement","getContext","width","dims","height","err","enabledInHierarchy","length","frame","start","Date","now","disposalType","clearRect","createImageData","data","set","patch","putImageData","drawImage","left","top","spriteFrame","createWithImage","end","renderDuration","scheduleOnce","delay"],"mappings":"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","sourcesContent":["import { Component, Sprite, SpriteFrame, _decorator } from \"cc\";\nimport { AS } from \"./ASComponent\";\nimport gif from \"./gif.js\";\nimport { error } from \"./Logger\";\n\nconst { ccclass, property, requireComponent } = _decorator;\n\n@ccclass(\"GifPlayer\")\n@requireComponent(Sprite)\nexport class GifPlayer extends AS(Component) {\n  @property _url = \"\";\n\n  @property _playOnLoad = true;\n\n  private _frames: any[] = [];\n\n  private _frameIndex = 0;\n\n  private _isPlaying = false;\n\n  private _width: number = 0;\n\n  private _height: number = 0;\n\n  private _sprite: Sprite | null = null;\n\n  private _tempCtx: CanvasRenderingContext2D | null = null;\n\n  private _tempCanvas: HTMLCanvasElement | null = null;\n\n  private _gifCanvas: HTMLCanvasElement | null = null;\n\n  private _gifCtx: CanvasRenderingContext2D | null = null;\n\n  private _frameImageData: ImageData | null = null;\n\n  @property get url() {\n    return this._url;\n  }\n\n  @property get playOnLoad() {\n    return this._playOnLoad;\n  }\n\n  get frameIndex() {\n    return this._frameIndex;\n  }\n\n  set url(value) {\n    if (this._url === value) return;\n    this._url = value;\n    this._loadGif();\n  }\n\n  set playOnLoad(value) {\n    this._playOnLoad = value;\n  }\n\n  set frameIndex(value) {\n    this._frameIndex = value;\n  }\n\n  play() {\n    this._isPlaying = true;\n    this._renderFrame();\n  }\n\n  pause() {\n    this._isPlaying = false;\n  }\n\n  async awake() {\n    this._sprite = this.getComponent(Sprite);\n    if (!this._sprite) {\n      error(`GifSprite requires a Sprite component`);\n      return;\n    }\n\n    this._loadGif();\n  }\n\n  onLoad() {\n    if (this._playOnLoad) {\n      this.play();\n    }\n  }\n\n  onEnable() {\n    if (this._isPlaying) {\n      this._renderFrame();\n    }\n  }\n\n  private _loadGif() {\n    if (!this._url) {\n      error(`GifSprite requires a url`);\n      return;\n    }\n\n    try {\n      fetch(this._url)\n        .then((res) => res.arrayBuffer())\n        .then((arrayBuffer) => {\n          const gifParsed = gif.parseGIF(arrayBuffer);\n          const frames = gif.decompressFrames(gifParsed, true);\n          // gif patch canvas\n          this._tempCanvas = document.createElement(\"canvas\");\n          this._tempCtx = this._tempCanvas.getContext(\"2d\");\n          // full gif canvas\n          this._gifCanvas = document.createElement(\"canvas\");\n          this._gifCtx = this._gifCanvas.getContext(\"2d\");\n\n          if (!this._tempCtx || !this._gifCtx) {\n            error(\"Failed to create canvas context\");\n            return;\n          }\n\n          this._width = this._gifCanvas.width = frames[0].dims.width;\n          this._height = this._gifCanvas.height = frames[0].dims.height;\n\n          this._frames = frames;\n\n          // debug(`Loaded ${this._frames.length} frames`, this._frames);\n\n          this._renderFrame();\n        });\n    } catch (err) {\n      error(`Error loading gif ${this._url}`, err);\n    }\n  }\n\n  private _renderFrame() {\n    if (!this.enabledInHierarchy || !this._frames || this._frames.length <= 0) return;\n\n    const frame = this._frames[this._frameIndex];\n    // debug(`Rendering frame ${this._frameIndex}`, frame);\n\n    const start = Date.now();\n\n    if (frame.disposalType === 2) {\n      this._gifCtx!.clearRect(0, 0, this._width, this._height);\n    }\n\n    const dims = frame.dims;\n    if (\n      !this._frameImageData ||\n      dims.width !== this._frameImageData.width ||\n      dims.height !== this._frameImageData.height\n    ) {\n      this._tempCanvas!.width = dims.width;\n      this._tempCanvas!.height = dims.height;\n      this._frameImageData = this._tempCtx!.createImageData(dims.width, dims.height);\n    }\n\n    // set the patch data as an override\n    this._frameImageData.data.set(frame.patch);\n\n    // draw the patch back over the canvas\n    this._tempCtx!.putImageData(this._frameImageData, 0, 0);\n    this._gifCtx!.drawImage(this._tempCanvas!, dims.left, dims.top);\n\n    this._sprite!.spriteFrame = SpriteFrame.createWithImage(this._gifCanvas!);\n    this._frameIndex++;\n    if (this._frameIndex >= this._frames.length) {\n      this._frameIndex = 0;\n    }\n\n    const end = Date.now();\n    const renderDuration = end - start;\n\n    if (this._isPlaying) {\n      this.scheduleOnce(() => this._renderFrame(), (frame.delay - renderDuration) / 1000);\n    }\n  }\n}\n"]}