{"version":3,"sources":["file:///Users/swayambhupanda/Documents/GitHub/applet-framework-demo/extensions/as_framework/framework/assets/scripts/UIPopup.ts"],"names":["BlockInputEvents","CCObject","Color","Node","Sprite","SpriteFrame","UITransform","Widget","_decorator","ColourRect","error","UIView","findParentCanvas","ccclass","property","disallowMultiple","UIPopup","formerlySerializedAs","tooltip","type","visible","enableBackground","_parentCanvas","_inputMask","_inputMaskView","isExclusive","_isExclusive","_enableBackground","blurSpriteFrame","_blurSpriteFrame","blurColor","_blurColor","exclusive","value","_updateExclusive","show","_isAwakeCalled","node","name","isVisible","_isAnimating","addChild","Promise","all","hide","removeChild","onEnable","onDisable","awake","hideFlags","Flags","DontSave","HideInHierarchy","layer","addComponent","showAnim","Animations","fadeIn","showDuration","hideAnim","fadeOut","hideDuration","inputMaskWidget","isAlignBottom","bottom","isAlignTop","top","isAlignRight","right","isAlignLeft","left","alignMode","AlignMode","ALWAYS","bg","bgWidget","blurSprite","spriteFrame","color","blurRect","originalParent","parent","on","EventType","NODE_DESTROYED","destroy","active","_onTouchEndMask","TOUCH_END","off"],"mappings":"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","sourcesContent":["import {\n  BlockInputEvents,\n  Canvas,\n  CCObject,\n  Color,\n  Node,\n  Sprite,\n  SpriteFrame,\n  UITransform,\n  Widget,\n  _decorator,\n} from \"cc\";\nimport { ColourRect } from \"./ColourRect\";\nimport { error } from \"./Logger\";\nimport { UIView } from \"./UIView\";\nimport { findParentCanvas } from \"./Utils\";\n\nconst { ccclass, property, disallowMultiple } = _decorator;\n\n@ccclass(\"UIPopup\")\n@disallowMultiple\nexport class UIPopup extends UIView {\n  @property private _isExclusive = false;\n\n  @property({ formerlySerializedAs: \"_enableBackgroundBlur\" }) private _enableBackground = false;\n\n  @property private _blurSpriteFrame: SpriteFrame | null = null;\n\n  @property private _blurColor = new Color(50, 50, 50, 128);\n\n  _parentCanvas: Canvas | null = null;\n\n  private _inputMask: Node | null = null;\n\n  private _inputMaskView: UIView | null = null;\n\n  @property({\n    tooltip: \"If enabled, the popup will not be hidden when a touch event occurs outside of it.\",\n  })\n  get isExclusive() {\n    return this._isExclusive;\n  }\n\n  @property({\n    tooltip: \"If enabled add a background sprite and/or color rect.\",\n  })\n  get enableBackground() {\n    return this._enableBackground;\n  }\n\n  @property({\n    type: SpriteFrame,\n    tooltip: \"Use the given spriteframe as the background behind the popup.\",\n    visible: function (this: UIPopup) {\n      return this.enableBackground;\n    },\n  })\n  get blurSpriteFrame(): SpriteFrame | null {\n    return this._blurSpriteFrame;\n  }\n\n  @property({\n    type: Color,\n    visible: function (this: UIPopup) {\n      return this.enableBackground;\n    },\n  })\n  get blurColor() {\n    return this._blurColor;\n  }\n\n  get exclusive() {\n    return this._isExclusive;\n  }\n\n  set isExclusive(value) {\n    if (this._isExclusive === value) return;\n\n    this._isExclusive = value;\n    this._updateExclusive();\n  }\n\n  set enableBackground(value) {\n    this._enableBackground = value;\n  }\n\n  set blurSpriteFrame(value: SpriteFrame | null) {\n    this._blurSpriteFrame = value;\n  }\n\n  set blurColor(value) {\n    this._blurColor = value;\n  }\n\n  set exclusive(value) {\n    if (this._isExclusive === value) return;\n\n    this._isExclusive = value;\n    this._updateExclusive();\n  }\n\n  async show() {\n    if (!this._isAwakeCalled || this._parentCanvas == null || this._inputMask == null) {\n      error(`The UI Popup in node:${this.node.name} not initilized.`);\n      return;\n    }\n\n    if (this.isVisible || this._isAnimating) return;\n\n    this._parentCanvas.node.addChild(this._inputMask);\n    this._parentCanvas.node.addChild(this.node);\n    await Promise.all([this._inputMaskView?.show(), super.show()]);\n  }\n\n  async hide() {\n    if (!this._isAwakeCalled) {\n      error(`The UI Popup in node:${this.node.name} not initilized.`);\n      return;\n    }\n\n    if (!this.isVisible || this._isAnimating) return;\n\n    await Promise.all([this._inputMaskView?.hide(), super.hide()]);\n    if (this._parentCanvas == null || this._inputMask == null) return;\n    this._parentCanvas.node.removeChild(this._inputMask);\n    this._parentCanvas.node.removeChild(this.node);\n  }\n\n  onEnable() {\n    this._updateExclusive();\n  }\n\n  onDisable() {\n    this._updateExclusive();\n  }\n\n  awake() {\n    // Mark this as a floating popup for layout\n    // const uiElement = this.getComponent(UIElement);\n    // if (uiElement) uiElement._setIsFloating(true);\n    // Create an input mask node.\n    this._inputMask = new Node(\"InputMask\");\n    this._inputMask.hideFlags |= CCObject.Flags.DontSave | CCObject.Flags.HideInHierarchy;\n    this._inputMask.layer = this.node.layer;\n    this._inputMask.addComponent(UITransform);\n    this._inputMask.addComponent(BlockInputEvents);\n    this._inputMaskView = this._inputMask.addComponent(UIView);\n    this._inputMaskView.showAnim = UIView.Animations.fadeIn;\n    this._inputMaskView.showDuration = this.showDuration;\n    this._inputMaskView.hideAnim = UIView.Animations.fadeOut;\n    this._inputMaskView.hideDuration = this.hideDuration;\n    const inputMaskWidget = this._inputMask.addComponent(Widget);\n    inputMaskWidget.isAlignBottom = true;\n    inputMaskWidget.bottom = 0;\n    inputMaskWidget.isAlignTop = true;\n    inputMaskWidget.top = 0;\n    inputMaskWidget.isAlignRight = true;\n    inputMaskWidget.right = 0;\n    inputMaskWidget.isAlignLeft = true;\n    inputMaskWidget.left = 0;\n    inputMaskWidget.alignMode = Widget.AlignMode.ALWAYS;\n\n    if (this.enableBackground) {\n      const bg = new Node(\"Background\");\n      bg.hideFlags |= CCObject.Flags.DontSave | CCObject.Flags.HideInHierarchy;\n      bg.layer = this.node.layer;\n      bg.addComponent(UITransform);\n      const bgWidget = bg.addComponent(Widget);\n      bgWidget.isAlignBottom = true;\n      bgWidget.bottom = 0;\n      bgWidget.isAlignTop = true;\n      bgWidget.top = 0;\n      bgWidget.isAlignRight = true;\n      bgWidget.right = 0;\n      bgWidget.isAlignLeft = true;\n      bgWidget.left = 0;\n      bgWidget.alignMode = Widget.AlignMode.ALWAYS;\n      this._inputMask.addChild(bg);\n\n      if (this.blurSpriteFrame) {\n        const blurSprite = bg.addComponent(Sprite);\n        blurSprite.spriteFrame = this.blurSpriteFrame;\n        blurSprite.color = this.blurColor;\n      } else {\n        const blurRect = bg.addComponent(ColourRect);\n        blurRect.color = this.blurColor;\n      }\n    }\n\n    this._parentCanvas = findParentCanvas(this.node);\n    // unparent the popup and the item template.\n    const originalParent = this.node.parent;\n    // Ensure this is also destroyed when parent is destroyed.\n    if (originalParent) {\n      originalParent.on(Node.EventType.NODE_DESTROYED, this.node.destroy, this);\n      originalParent.on(Node.EventType.NODE_DESTROYED, this._inputMask.destroy, this);\n    }\n    this.node.parent = null;\n    this.node.active = false;\n    this._inputMask.active = false;\n    this._inputMask.parent = null;\n\n    this._updateExclusive();\n\n    this.node.active = false;\n  }\n\n  private _onTouchEndMask() {\n    this.hide();\n  }\n\n  private _updateExclusive() {\n    if (!this._inputMask) return;\n    if (!this.exclusive) {\n      this._inputMask.on(Node.EventType.TOUCH_END, this._onTouchEndMask, this);\n    } else {\n      this._inputMask.off(Node.EventType.TOUCH_END, this._onTouchEndMask, this);\n    }\n  }\n}\n"]}