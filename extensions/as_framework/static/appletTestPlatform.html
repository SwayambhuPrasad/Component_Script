<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-chache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <script src="https://cdn.socket.io/4.0.1/socket.io.js"></script>

    <title>Collaborative Applet</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>

    <div class="d-flex flex-column align-items-center h-100">
      <div class="align-self-stretch flex-grow-1">
        <iframe id="appletFrame" src="/applet" frameborder="0" width="100%" height="100%"></iframe>
      </div>
      <p id="appStatus">This applet is unlocked</p>
      <div class="btn-toolbar p-2" role="toolbar" aria-label="Toolbar">
        <div class="btn-group me-2" role="group" aria-label="Screen shot">
          <button
            type="button"
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#screenCaptureModal"
            data-bs-toggle="tooltip"
            data-bs-placement="bottom"
            title="Take Screenshot from this applet"
            onclick="ScreenCapture()"
          >
            Screenshot
          </button>
        </div>
        <div class="btn-group me-2" role="group" aria-label="Synchronisation">
          <button
            type="button"
            class="btn btn-success"
            data-bs-toggle="tooltip"
            data-bs-placement="bottom"
            title="Manually sync other Applets using this applet"
            onclick="GetActivityState()"
          >
            Sync
          </button>
          <button
            type="button"
            class="btn btn-warning"
            data-bs-toggle="tooltip"
            data-bs-placement="bottom"
            title="Reload this Applet"
            onclick="ReloadApplet()"
          >
            Reload
          </button>
          <button
            type="button"
            class="btn btn-danger"
            data-bs-toggle="tooltip"
            data-bs-placement="bottom"
            title="Reload all Applets"
            onclick="ReloadApplets()"
          >
            Reload All
          </button>
        </div>
        <div class="btn-group" role="group" aria-label="Lock">
          <button
            type="button"
            class="btn btn-warning"
            data-bs-toggle="tooltip"
            data-bs-placement="bottom"
            title="Lock this Applet"
            onclick="AppletLock()"
          >
            Lock
          </button>
          <button
            type="button"
            class="btn btn-primary"
            data-bs-toggle="tooltip"
            data-bs-placement="bottom"
            title="Unlock this Applet"
            onclick="AppletUnlock()"
          >
            Unlock
          </button>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div
      class="modal fade"
      id="screenCaptureModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="screenCaptureModalTitle"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="screenCaptureModalTitle">Captured Image</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <img
              src="https://via.placeholder.com/668x1138.png?text=No+Screenshot"
              alt="No ScreenShot"
              id="ScreenShot"
            />
          </div>
        </div>
      </div>
    </div>

    <script>
      // initalize all tooltips.
      var tooltipTriggerList = [].slice.call(
        document.querySelectorAll('[data-bs-toggle="tooltip"]'),
      );
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
      // get the applet iframe
      const Applet = document.getElementById("appletFrame")?.contentWindow;

      // connect the webpage to the socket url
      let socket = io.connect(location.href);

      // Add an event listener to get the message from the iframe to
      // push to the websocket
      window.addEventListener("message", (payload) => {
        // console.log("Got this message type from the applet:", message.data.type);
        // send the message to the websocket
        socket.emit("msg2socket", payload.data);
        if (payload.data.type === "ScreenCapture") {
          // let link = document.createElement("a");
          // link.download = "DownloadScreenShot";
          // link.href = message.data.message;
          // document.body.appendChild(link);
          // link.click();
          const screenCaptureImg = document.getElementById("ScreenShot");
          if (screenCaptureImg) screenCaptureImg.src = payload.data.message;
        }
      });

      // On receiving the message from socket, relay it to the iframe
      socket.on("msg2app", (message) => {
        console.log(`Socket --- ${message}`);
        if (Applet) Applet.postMessage(message, "*");
      });

      // Reload the page when server requests it.
      socket.on("reload", () => location.reload());

      // Single Applet Reload function
      function ReloadApplets() {
        console.log("Initiated All Applet(s) Reload!");
        var message = { type: "ReloadApplet", message: null };
        if (Applet) Applet.postMessage(message, "*");
        const appStatus = document.getElementById("appStatus");
        if (appStatus) appStatus.innerHTML = "All applets reloaded from this tab!";
      }

      // Single Applet Reload function
      function ReloadApplet() {
        console.log("Initiated Single Applet Reload!");
        var message = { type: "ReloadApplet", message: "HOME" };
        if (Applet) Applet.postMessage(message, "*");
        const appStatus = document.getElementById("appStatus");
        if (appStatus) appStatus.innerHTML = "This applet alone is reloaded!";
      }

      // Applet Synchronisation function
      function GetActivityState() {
        console.log("Initiated Applet Synchronisation!");
        var message = { type: "GetActivityState", message: null };
        if (Applet) Applet.postMessage(message, "*");
        const appStatus = document.getElementById("appStatus");
        if (appStatus) appStatus.innerHTML = "Data synchronisation initiated from this tab!";
      }

      // Applet Screenshot function
      function ScreenCapture() {
        console.log("Initiated Applet ScreenShot!");
        var message = { type: "GetScreenCapture", message: null };
        if (Applet) Applet.postMessage(message, "*");
        const appStatus = document.getElementById("appStatus");
        if (appStatus) appStatus.innerHTML = "Screenshot Initiated!";
      }

      // Applet Lock function
      function AppletLock() {
        console.log("Initiated Applet Lock!");
        var message = { type: "LockApplet", message: 1 };
        if (Applet) Applet.postMessage(message, "*");
        const appStatus = document.getElementById("appStatus");
        if (appStatus) appStatus.innerHTML = "This applet is LOCKED!";
      }

      // Applet Unlock function
      function AppletUnlock() {
        console.log("Initiated Applet Unlock!");
        var message = { type: "LockApplet", message: 0 };
        if (Applet) Applet.postMessage(message, "*");
        const appStatus = document.getElementById("appStatus");
        if (appStatus) appStatus.innerHTML = "This applet is UNLOCKED!";
      }
    </script>
  </body>
</html>
